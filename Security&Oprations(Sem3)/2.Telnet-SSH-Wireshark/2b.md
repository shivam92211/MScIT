
# Lab: Investigating an Attack on a Windows Host

## Objectives
- **Part 1**: Investigate the attack with Sguil.
- **Part 2**: Use Kibana to investigate alerts.

## Background / Scenario
In March 2019, network security monitoring tools alerted that a Windows computer on the network was infected with malware. In this task, you will investigate the alerts and answer the following questions:
- What was the specific time of the attack on 2019-03-19?
- Which Windows host computer was infected? Who was the user?
- What was the computer infected with?

This lab is based on materials from [malware-traffic-analysis.net](https://malware-traffic-analysis.net), an excellent resource for learning how to analyze network and host attacks.

### Required Resources
- Security Onion virtual machine
- Internet access

---

## Part 1: Investigate the Attack with Sguil

### Step 1: Open Sguil and locate the alerts on 3-19-2019
1. **Log in to the Security Onion VM**:
   - Username: `analyst`
   - Password: `cyberops`

2. **Launch Sguil** from the desktop:
   - Log in with username `analyst` and password `cyberops`.
   - Click **Select All** and **Start Sguil** to view all the alerts generated by the network sensors.

3. **Locate the group of alerts** from 19 March 2019:
   - According to Sguil, what are the timestamps for the first and last of the alerts that occurred on 3-19-2019?
     - **Answer**: `01:45:03` to `04:54:34`. The alerts show suspicious activity for a little over 3 hours, but the majority of the alerts took place over 3 minutes and 43 seconds.

### Step 2: Review the alerts in detail
1. **Examine the first alert** (Alert ID 5.439):
   - Check the **Show Packet Data** and **Show Rule** checkboxes to examine the packet header information and the IDS signature rule related to the alert.
   - Right-click the Alert ID and pivot to Wireshark.

   **Questions**:
   - What was the source IP address and port number, and destination IP address and port number?
     ```plaintext
     Source: 10.0.90.215:52609, Destination: 10.0.90.9:53
     ```
   - What type of protocol and request or response was involved?
     ```plaintext
     UDP, Dynamic DNS, update and response
     ```
   - What is the IDS alert and message?
     ```plaintext
     Alert udp $EXTERNAL_NET any -> $HOME_NET 53, msg: "ET POLICY DNS Update from External net"
     ```
   - Do you think this alert was the result of an IDS misconfiguration or a legitimate suspicious communication?
     ```plaintext
     This alert may be the result of a misconfiguration in the IDS because the DNS request was a Dynamic DNS update from an internal host to a DNS server on the internal network and not from an external network to the internal network.
     ```
   - What is the hostname, domain name, and IP address of the source host in the DNS update?
     ```plaintext
     Bobby-Tiger-PC, littletigers.info, 10.0.90.215
     ```

2. **Examine the second alert** (Alert ID 5.440):
   - Right-click the Alert ID and select **Transcript**.

   **Questions**:
   - What is the source and destination IP address and port numbers?
     ```plaintext
     Source: 10.0.90.215:49204, Destination: 209.141.34.8:80
     ```
   - Looking at the request (blue), what was the request for?
     ```plaintext
     GET /test1.exe
     ```
   - What is the initial few characters of the file? Search for this file signature to find out what type of file was downloaded.
     ```plaintext
     MZ (Windows executable .exe or .dll file)
     ```

3. **Export the executable file** for malware analysis:
   - In Wireshark, go to **File > Export Objects > HTTP...**.
   - Save the file (`test1.exe`) to the analyst’s home folder.

4. **Create a SHA256 hash** of the exported file:
   ```bash
   sha256sum test1.exe
   ```
   - Copy the hash and submit it to the Cisco Talos File Reputation Center: [https://talosintelligence.com/talos_file_reputation](https://talosintelligence.com/talos_file_reputation).
   - **Question**: Did Talos recognize the file hash and identify it as malware? If so, what kind of malware?
     ```plaintext
     Yes, win32 trojan-spy-agent
     ```

5. **Examine the Remcos RAT Checkin alert** (Alert ID 5.480):
   - Right-click the Alert ID and select **Transcript**.

   **Questions**:
   - What is the destination port of the communication? Is it a well-known port?
     ```plaintext
     Destination port: 2404 (not a well-known port)
     ```
   - Is the communication readable or is it encrypted?
     ```plaintext
     Encrypted
     ```
   - What does Remcos stand for?
     ```plaintext
     Remote control and surveillance software
     ```
   - What type of encryption and obfuscation was used to bypass detection?
     ```plaintext
     Remcos RAT uses multiple packers, base64 encoding, and RC4 encryption.
     ```

6. **Locate the second executable file**:
   - Identify the Alert IDs that indicate a second executable file being downloaded.
     ```plaintext
     Example: 5.483, 5.485, 5.497, 5.509, 5.521, 5.533
     ```
   - From which server IP address and port number was the file downloaded?
     ```plaintext
     217.23.14.81:80
     ```
   - What is the name of the file that was downloaded?
     ```plaintext
     F4.exe
     ```
   - Create a SHA256 hash of the file and submit it to Cisco Talos:
     ```bash
     sha256sum F4.exe
     ```
   - **Question**: Is the executable file known malware? If so, what type? What is the AMP DETECTION NAME?
     ```plaintext
     Yes, PE32 executable, trojan downloader Win.Dropper.Cridex::1201
     ```

7. **Examine the remaining alerts**:
   - How are all three alerts related?
     ```plaintext
     All three alerts are encrypted and triggered by a blacklisted malicious SSL certificate – Dridex.
     ```

---

## Part 2: Use Kibana to Investigate Alerts

### Step 1: Open Kibana and narrow the timeframe
1. **Log in to Kibana**:
   - Username: `analyst`
   - Password: `cyberops`

2. **Change the time range**:
   - Click **Last 24 Hours** and select the **Absolute time range** tab.
   - Set the time range to March 1, 2019, to March 31, 2019.

3. **Narrow the focus**:
   - Click the event on March 19 in the **Total Log Count Over Time** timeline.

### Step 2: Review the alerts in the narrowed timeframe
1. **Scroll down to the All Sensors – Log Type visualization**:
   - Note the variety of log types related to this attack.

2. **Filter on the second alert**:
   - Click the magnifier to filter on the alert: `ET TROJAN ABUSE.CH SSL Blacklist Malicious SSL certificate detected (Dridex)` from Source IP Address `31.22.4.176`.

3. **Expand the first log**:
   - What is the geo country and city location for this alert?
     ```plaintext
     United Kingdom, Newcastle upon Tyne
     ```
   - What is the geo country and city for the alert from `115.112.43.81`?
     ```plaintext
     India, Mumbai
     ```

4. **Review the HTTP dashboard**:
   - What is the Log Count in the HTTP dashboard? From what countries?
     ```plaintext
     4, United States and Netherlands
     ```
   - What are the URIs for the files that were downloaded?
     ```plaintext
     /f4.exe, /ncsi.txt, /pki/crl/products/CSPCA.crl, and /test1.exe
     ```

5. **Match the HTTP – URIs to the HTTP – Sites**:
   - What are the `CSPCA.crl` and `ncsi.txt` files related to?
     ```plaintext
     CSPCA.crl is a request for the Microsoft certificate revocation list, and ncsi.txt refers to the network connection status indicator used by Windows hosts for online connectivity verification.
     ```

6. **Check DNS queries**:
   - Submit the URL `toptoptop1.online` to [VirusTotal](https://www.virustotal.com).
   - **Result**:
     ```plaintext
     4 detection engines recognize the URL as malicious regarding malware.
     ```

---

## Reflection
This lab demonstrates how to use tools like Sguil and Kibana to investigate network alerts and identify malware infections. It highlights the importance of analyzing logs, exporting files for further analysis, and using threat intelligence platforms like Cisco Talos to confirm malware detections.
